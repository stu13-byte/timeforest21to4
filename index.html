<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹œê°„ì˜ ìˆ²: ì‹œê³„í† ë¼ë¥¼ ì¡ì•„ë¼!</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&family=Gamja+Flower&display=swap');
    
    :root {
      --primary-color: #8d6e63;
      --accent-color: #c62828;
      --bg-color: #fdfcf5;
      --ui-bg: rgba(255, 255, 255, 0.98);
    }

    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Jua', sans-serif;
      background: var(--bg-color);
      background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
      background-size: 20px 20px;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }

    .screen {
      width: 100%; max-width: 900px; height: 95vh;
      background: var(--ui-bg);
      border-radius: 25px; border: 8px solid var(--primary-color);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none; 
      flex-direction: column; 
      align-items: center; 
      padding: 20px; 
      position: relative;
      animation: fadeIn 0.5s ease-out;
      overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ ì»¨í…Œì´ë„ˆëŠ” ë„˜ì¹¨ ìˆ¨ê¹€ */
    }
    .screen.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒì„ ìœ„í•œ ìŠ¤í¬ë¡¤ ë˜í¼ */
    .scrollable-content {
        flex: 1; 
        overflow-y: auto; 
        width: 100%; 
        display: flex; 
        flex-direction: column; 
        align-items: center;
        padding: 10px 0;
        min-height: 0; /* Flexbox overflow fix */
        scrollbar-width: thin; /* Firefox ìŠ¤í¬ë¡¤ë°” ì–‡ê²Œ */
    }
    
    /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ */
    .footer-action {
        width: 100%;
        margin-top: auto;
        padding-top: 10px;
        display: flex;
        justify-content: center;
        flex-shrink: 0; /* ê³µê°„ ë¶€ì¡±í•´ë„ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    }

    .intro-story {
      text-align: center; font-family: 'Gamja Flower', cursive; font-size: 1.6rem;
      background: #fff8e1; padding: 20px; border-radius: 15px; margin-bottom: 20px;
      border: 3px dashed var(--primary-color); width: 85%; line-height: 1.5; color: #4e342e;
    }
    .login-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; margin-top: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { color: var(--primary-color); font-size: 1.2rem; }
    .input-group select, .input-group input { padding: 12px; border: 2px solid #bcaaa4; border-radius: 10px; font-family: 'Jua'; font-size: 1.2rem; }

    .player-list { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; min-height: 50px; }
    .player-badge { background: #ffecb3; padding: 8px 15px; border-radius: 20px; border: 2px solid #ffca28; color: #5d4037; font-size: 1.2rem; display: flex; align-items: center; gap: 5px; animation: pop 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    .btn { padding: 12px 30px; border: none; border-radius: 15px; font-family: 'Jua'; font-size: 1.4rem; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; color: white; margin: 10px; }
    .btn-primary { background: var(--accent-color); box-shadow: 0 4px 0 #8e0000; }
    .btn-secondary { background: var(--primary-color); box-shadow: 0 4px 0 #5d4037; }
    .btn-info { background: #0288d1; box-shadow: 0 4px 0 #01579b; }
    .btn-success { background: #2e7d32; box-shadow: 0 4px 0 #1b5e20; }
    .btn-neutral { background: #757575; box-shadow: 0 4px 0 #424242; }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; opacity: 0.7; transform: none; }

    .lobby-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
    .lobby-content { display: flex; width: 100%; flex: 1; gap: 20px; overflow: hidden; min-height: 0; }
    .char-select-area { flex: 2; background: #fff; border-radius: 15px; border: 3px solid #efebe9; padding: 15px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
    .record-area { flex: 1; background: #fff3e0; border-radius: 15px; border: 3px solid #ffe0b2; padding: 15px; text-align: center; display: flex; flex-direction: column; overflow-y: auto; }

    .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 10px; overflow-y:auto; padding-bottom: 10px; }
    .shop-item { border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; position: relative; background: #fafafa; }
    .shop-item.locked { filter: grayscale(1); opacity: 0.7; }
    .shop-item.selected { border-color: var(--accent-color); background: #ffebee; border-width: 3px; transform: scale(1.02); }
    .shop-item img { width: 70px; height: 70px; object-fit: contain; margin-bottom: 5px; }
    .shop-price { font-size: 1rem; color: #f57f17; font-weight: bold; }
    .lock-icon { position: absolute; top: 5px; right: 5px; font-size: 1.2rem; }

    .game-options { width: 100%; background: #e0f2f1; padding: 15px; border-radius: 15px; margin-top: auto; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0;}
    .option-row { display: flex; align-items: center; gap: 10px; color: #00695c; font-size: 1.1rem; cursor: pointer; }
    .option-row input { width: 22px; height: 22px; accent-color: #00897b; cursor: pointer; }

    .game-status-panel { width: 100%; display: flex; justify-content: space-between; align-items: center; background: #fff3e0; padding: 10px 20px; border-radius: 15px; border: 3px solid #ffcc80; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-shrink: 0; }
    .current-player-info { display: flex; align-items: center; gap: 15px; }
    .current-char-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--accent-color); background: #fff; object-fit: contain; transition: transform 0.2s; }
    .turn-text-box { display: flex; flex-direction: column; align-items: flex-start; }
    .turn-label { font-size: 0.9rem; color: #5d4037; }
    .player-name-large { font-size: 1.5rem; font-weight: bold; color: var(--accent-color); }
    .player-score-large { font-size: 1.1rem; color: #f57f17; font-weight: bold; }
    .timer-container { display: flex; flex-direction: column; align-items: flex-end; width: 40%; }
    .timer-text { font-size: 2rem; font-weight: bold; color: #333; font-family: monospace; letter-spacing: -1px;}
    .timer-bar { width: 100%; height: 12px; background: #eee; border-radius: 10px; overflow: hidden; border: 1px solid #ccc; margin-top: 5px; }
    .timer-fill { height: 100%; background: #4caf50; width: 100%; transition: width 1s linear; }
    
    .problem-container { 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        flex: 1; width: 100%; position: relative; padding-top: 5px; 
        min-height: 0; /* Flex fix */
    }
    .problem-text { font-size: 2rem; color: #3e2723; margin-bottom: 10px; text-align: center; min-height: 40px;}
    
    /* ì‹œê³„ í¬ê¸° ë°˜ì‘í˜• ì¡°ì • */
    .clock-wrapper { position: relative; width: 35vh; height: 35vh; max-width: 300px; max-height: 300px; margin-bottom: 15px; flex-shrink: 0; }
    canvas { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: grab; background: #fff;}
    canvas:active { cursor: grabbing; }
    
    .input-wrapper { display: flex; gap: 10px; align-items: center; font-size: 1.8rem; display: none; }
    .time-input { width: 80px; height: 60px; font-size: 2rem; text-align: center; border: 4px solid var(--primary-color); border-radius: 15px; background: #fff8e1; color: #333; }
    .hint-bubble { background: #fff9c4; padding: 10px 20px; border-radius: 30px; border: 3px solid #fbc02d; color: #5d4037; margin-bottom: 10px; font-size: 1.2rem; display: none; animation: pop 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    .feedback-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10rem; font-weight: bold; text-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none; opacity: 0; z-index: 50; }
    .feedback-correct { color: #2e7d32; }
    .feedback-wrong { color: #c62828; }
    @keyframes feedbackPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

    .result-rank { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .result-rank th { border-bottom: 2px solid var(--primary-color); padding: 10px; color: var(--accent-color); background: #fbe9e7;}
    .result-rank td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 1.3rem; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(3px); }
    .modal-content { background: #fff; padding: 30px; border-radius: 25px; max-width: 550px; width: 90%; text-align: center; border: 6px solid var(--primary-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; max-height: 90vh; overflow-y: auto; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #888; line-height: 20px;}
    
    .toast-message { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(60, 40, 0, 0.95); color: #fff; padding: 15px 40px; border-radius: 30px; font-size: 1.4rem; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 80%; max-width: 600px; border: 2px solid #ffb74d; white-space: pre-line; line-height: 1.4; }
    
    /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.7); 
        display: none; justify-content: center; align-items: center; z-index: 3000;
        flex-direction: column; font-size: 1.5rem; font-weight: bold; color: var(--primary-color);
    }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ìºë¦­í„° ìƒì„¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .char-detail-img { width: 150px; height: 150px; object-fit: contain; margin-bottom: 15px; border-radius: 50%; background: #fafafa; border: 4px solid #eee; }
    .char-detail-name { font-size: 2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; }
    .char-detail-desc { font-size: 1.2rem; color: #666; margin-bottom: 20px; }
    .char-detail-price { font-size: 1.5rem; color: #f57f17; font-weight: bold; margin-bottom: 20px; }
    .modal-btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }

    /* --- íƒœë¸”ë¦¿ ë° ì‘ì€ ë†’ì´ í™”ë©´ ìµœì í™” (ê°€ë¡œ ëª¨ë“œ) --- */
    @media (max-height: 700px) {
        .screen { padding: 10px; }
        h1 { font-size: 2rem !important; margin-bottom: 5px !important; }
        .intro-story { font-size: 1.2rem; padding: 10px; width: 95%; margin-bottom: 10px; }
        .login-panel { gap: 10px; margin-top: 5px; }
        .input-group label { font-size: 1rem; }
        .input-group select, .input-group input { padding: 8px; font-size: 1rem; }
        .player-list { min-height: 40px; margin-top: 10px; }
        .player-badge { padding: 5px 10px; font-size: 1rem; }
        .btn { padding: 8px 20px; font-size: 1.2rem; margin: 5px; }
        .shop-grid { grid-template-columns: repeat(4, 1fr); }
        .shop-item img { width: 50px; height: 50px; }
        .game-options { padding: 10px; }
        .clock-wrapper { width: 40vh; height: 40vh; max-width: 250px; max-height: 250px; }
        .problem-text { font-size: 1.5rem; min-height: 30px; margin-bottom: 5px; }
        .input-wrapper { font-size: 1.4rem; }
        .time-input { width: 60px; height: 50px; font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<!-- API URL ì„¤ì • ì¤‘ìš”! -->
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKoPs7XqOKz_XLDFj876YWYAZiI3hKaJ8VazqSK9-n9yhBiVjDyTuisY1Mqx1qw_tFpg/exec"; // â˜…â˜…â˜… ë°°í¬í•œ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! â˜…â˜…â˜…
</script>

<div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>
</div>

<div id="toast" class="toast-message"></div>
<div id="feedback-anim" class="feedback-overlay"></div>

<!-- 1. ì¸íŠ¸ë¡œ -->
<div id="screen-intro" class="screen active">
    <h1 style="color:var(--accent-color); font-size:3rem; margin-bottom:10px; text-shadow: 2px 2px 0px #fff; flex-shrink: 0;">â³ ì‹œê°„ì˜ ìˆ²</h1>
    
    <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì¤‘ê°„ ì˜ì—­ -->
    <div class="scrollable-content">
        <div class="intro-story">
            "í°ì¼ ë‚¬ì–´! <b>ì‹œê³„í† ë¼</b>ê°€ ì‹œê°„ì„ ì—‰ë§ìœ¼ë¡œ ë§Œë“¤ê³  ë„ë§ê°”ì–´!"<br>
            ì˜¬ë°”ë¥¸ ì‹œê°ì„ ë§ì¶°ì„œ ì¹œêµ¬ë“¤ì„ êµ¬í•˜ê³  í† ë¼ë¥¼ ì¡ì•„ì¤„ë˜?
        </div>
        <div class="login-panel">
            <div class="input-group">
                <label>ìš°ë¦¬ ë°˜</label>
                <select id="login-class" onchange="loadStudentNames()">
                    <option value="">ë°˜ ì„ íƒ</option>
                    <option value="1">1ë°˜</option>
                    <option value="2">2ë°˜</option>
                    <option value="3">3ë°˜</option>
                    <option value="4">4ë°˜</option>
                    <option value="5">5ë°˜(í…ŒìŠ¤íŠ¸)</option>
                </select>
            </div>
            <div class="input-group">
                <label>ì´ë¦„</label>
                <select id="login-name"><option value="">ì´ë¦„ ì„ íƒ</option></select>
            </div>
            <div class="input-group" style="grid-column: 1 / -1;">
                <label>ë‚´ ë²ˆí˜¸ (ë¹„ë°€ë²ˆí˜¸)</label>
                <input type="number" id="login-pwd" placeholder="ì˜ˆ: 5" onkeypress="if(event.keyCode==13) addPlayer()">
            </div>
        </div>
        <button class="btn btn-secondary" onclick="addPlayer()" style="width: 200px; margin-top: 20px; flex-shrink:0;">ì¹œêµ¬ ì¶”ê°€ (+)</button>
        <div class="player-list" id="intro-player-list"></div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
    <div class="footer-action">
        <button class="btn btn-primary" id="btn-goto-lobby" onclick="goToLobby()" disabled style="font-size: 1.6rem; padding: 15px 50px;">ë¡œë¹„ë¡œ ì…ì¥ â–¶</button>
    </div>
</div>

<!-- 2. ë¡œë¹„ -->
<div id="screen-lobby" class="screen">
    <div class="lobby-header">
        <h2 style="margin:0; font-size: 2rem;">ğŸ•ï¸ ë² ì´ìŠ¤ìº í”„</h2>
        <div><button class="btn btn-info" style="padding: 10px 20px;" onclick="openHelp()">ê²Œì„ ë°©ë²•</button></div>
    </div>
    
    <div class="lobby-content">
        <div class="char-select-area">
            <h3 style="margin-top:0; font-size:1.5rem; flex-shrink:0;">ğŸ¦¸ ìºë¦­í„° ì„ íƒ & ìƒì </h3>
            <div style="width:100%; text-align:right; color:#f57f17; font-weight:bold; font-size:1.2rem; margin-bottom:5px; flex-shrink:0;">
                ë³´ìœ  í¬ì¸íŠ¸: <span id="lobby-points">0</span> P
            </div>
            <div class="shop-grid" id="shop-grid"></div>
            <div class="game-options">
                <h4 style="margin:0 0 10px 0;">âš™ï¸ ì„ ìƒë‹˜ ì„¤ì •</h4>
                <div class="option-row" onclick="toggleCheckbox('opt-before')">
                    <input type="checkbox" id="opt-before"><label for="opt-before">ë„ì „! 'ëª‡ ë¶„ ì „' ë¬¸ì œ í¬í•¨</label>
                </div>
                <div class="option-row" onclick="toggleCheckbox('opt-hard')">
                    <input type="checkbox" id="opt-hard"><label for="opt-hard">ì‹¬í™”! 1ë¶„ ë‹¨ìœ„ (ì¶”ê°€ì ìˆ˜)</label>
                </div>
            </div>
        </div>
        <div class="record-area">
            <h3 style="margin-top:0; font-size:1.5rem; flex-shrink:0;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
            <div style="margin-bottom:15px; background:#fff; padding:15px; border-radius:15px; flex-shrink:0;">
                <div style="font-size:1rem; color:#888;">ë‚˜ì˜ ìµœê³  ê¸°ë¡</div>
                <div style="font-size:2rem; color:var(--accent-color); font-weight:bold;" id="my-best-score">-</div>
            </div>
            <div style="text-align:left; flex:1; overflow-y:auto; width:100%;">
                <h4 style="border-bottom:2px solid #ccc; padding-bottom:5px; margin-bottom:10px;">í•™ë…„ TOP 5</h4>
                <ul id="rank-list" style="padding-left:20px; line-height:1.8; font-size: 1.1rem;"></ul>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
    <div class="footer-action">
        <button class="btn btn-primary" style="width:100%; font-size: 1.8rem;" onclick="startGame()">ê²Œì„ ì‹œì‘!</button>
    </div>
</div>

<!-- 3. ê²Œì„ -->
<div id="screen-game" class="screen">
    <div class="game-status-panel">
        <div class="current-player-info">
            <img src="" id="game-char-img" class="current-char-img" alt="ìºë¦­í„°">
            <div class="turn-text-box">
                <span class="turn-label">ì§€ê¸ˆì€ ëˆ„êµ¬ ì°¨ë¡€?</span>
                <span id="game-player-name" class="player-name-large">í”Œë ˆì´ì–´</span>
                <span id="game-score-info" class="player-score-large">0ì </span>
            </div>
        </div>
        <div class="timer-container">
            <div id="timer-text" class="timer-text">03:00</div>
            <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>
        </div>
    </div>
    
    <!-- ë¬¸ì œ ì˜ì—­ -->
    <div class="problem-container">
        <div class="problem-text" id="problem-text">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="hint-bubble" id="hint-bubble"></div>
        <div class="clock-wrapper"><canvas id="gameCanvas" width="300" height="300"></canvas></div>
        <div class="input-wrapper" id="input-wrapper">
            <input type="number" inputmode="numeric" class="time-input" id="inp-hour"> <span style="font-size:1.8rem;">ì‹œ</span>
            <input type="number" inputmode="numeric" class="time-input" id="inp-min"> <span style="font-size:1.8rem;">ë¶„</span>
            <span id="text-suffix" style="display:none; font-size:1.8rem;"> ì „</span>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
    <div class="footer-action" style="margin-bottom: 0;">
        <button class="btn btn-primary" onclick="submitAnswer()" style="width:300px; font-size: 1.6rem;">ì •ë‹µ í™•ì¸</button>
    </div>
</div>

<!-- 4. ê²°ê³¼ -->
<div id="screen-result" class="screen">
    <h1 style="color:var(--accent-color); font-size: 3rem; margin-bottom: 10px; flex-shrink: 0;">ğŸ‰ ê²Œì„ ì¢…ë£Œ!</h1>
    
    <div class="scrollable-content">
        <div style="font-size:1.5rem; margin-bottom:20px; text-align: center;">ëª¨ë‘ ìˆ˜ê³ í–ˆì–´! í† ë¼ë¥¼ ì¡ì•˜êµ¬ë‚˜!</div>
        <div style="width:100%; max-width:700px; background:#fff; padding:20px; border-radius:15px; border:3px solid #eee; overflow-y:auto; max-height: 50vh;">
            <table class="result-rank">
                <thead><tr><th width="15%">ìˆœìœ„</th><th width="30%">ì´ë¦„</th><th width="25%">ì ìˆ˜</th><th width="30%">íšë“ í¬ì¸íŠ¸</th></tr></thead>
                <tbody id="result-list"></tbody>
            </table>
        </div>
    </div>

    <div class="footer-action">
        <button class="btn btn-secondary" onclick="goToLobby()" style="padding: 15px 40px; font-size: 1.5rem;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="modal-help" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeHelp()">&times;</span>
        <h2 style="color:var(--primary-color);">ğŸ“œ ê²Œì„ ë°©ë²•</h2>
        <ul style="text-align:left; line-height:2; font-size: 1.2rem;">
            <li>ëª¨ë“  ì¹œêµ¬ì—ê²Œ <b>ê°ê° 3ë¶„</b>ì˜ ì‹œê°„ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.</li>
            <li>í‹€ë¦¬ë©´ <b>1ë²ˆì˜ íŒíŠ¸ ê¸°íšŒ</b>ê°€ ìˆì–´ìš”.</li>
            <li style="color:#c62828;"><b>ğŸ”¥ 3ì—°ì† ì •ë‹µ</b>ì‹œ ë³´ë„ˆìŠ¤ ì ìˆ˜!</li>
            <li style="color:#2e7d32;"><b>âš¡ 10ì´ˆ ì•ˆì—</b> ë§ì¶”ë©´ ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤!</li>
            <li style="color:#f57f17;"><b>âœ¨ ì‹¬í™” ë¬¸ì œ</b>ëŠ” ì ìˆ˜ë¥¼ ë” ì¤˜ìš”!</li>
        </ul>
    </div>
</div>

<!-- ìºë¦­í„° ìƒì„¸ ëª¨ë‹¬ -->
<div id="modal-char-detail" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeCharModal()">&times;</span>
        <h2 style="color:var(--primary-color);">ìºë¦­í„° ìƒì„¸ ì •ë³´</h2>
        <img id="detail-char-img" class="char-detail-img" src="" alt="ìºë¦­í„° ìƒì„¸">
        <div id="detail-char-name" class="char-detail-name"></div>
        <div id="detail-char-desc" class="char-detail-desc"></div>
        <div id="detail-char-price" class="char-detail-price"></div>
        
        <div style="font-size: 1.3rem; margin-bottom: 10px; font-weight: bold; color: #333;" id="detail-question">êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
        
        <div class="modal-btn-group" id="detail-btn-group">
            <!-- ë²„íŠ¼ì€ JSì—ì„œ ë™ì  ìƒì„± -->
        </div>
    </div>
</div>

<script>
    // --- ìœ í‹¸ë¦¬í‹° ---
    function showToast(msg) {
        const el = document.getElementById('toast'); el.textContent = msg; el.style.opacity = '1';
        setTimeout(() => { el.style.opacity = '0'; }, 2000);
    }
    function toggleCheckbox(id) { const el = document.getElementById(id); el.checked = !el.checked; }
    function setLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

    // --- ë°ì´í„° (ë¡œì»¬ ëª…ë‹¨ì€ ë¡œê·¸ì¸ìš©, ë‚˜ë¨¸ì§€ ë°ì´í„°ëŠ” ì„œë²„ì—ì„œ ì˜´) ---
    const DB_STUDENTS = {
        "1": [
            {name:"ê°•íƒœìœ¨",pwd:"2"},{name:"ê³½ì„œì§„",pwd:"3"},{name:"ê¶Œíš¨ë¹ˆ",pwd:"4"},{name:"ê¹€ì†Œì€",pwd:"5"},
            {name:"ê¹€ì†Œì •",pwd:"6"},{name:"ê¹€í˜¸ì—°",pwd:"7"},{name:"ë…¸í•˜ìœ¤",pwd:"8"},{name:"ë¬¸ì„¸ì™€",pwd:"9"},
            {name:"ë¬¸ì„¸ì¤€",pwd:"10"},{name:"ë°•ì€ì„¤",pwd:"11"},{name:"ì†¡ë‹¤ì€",pwd:"12"},{name:"ì•ˆì„œí˜„",pwd:"13"},
            {name:"ì•ˆíƒœì€",pwd:"14"},{name:"ìœ¤ì£¼ì›",pwd:"15"},{name:"ì´ë‹¤ì—°",pwd:"16"},{name:"ì´ì„±ì°¬",pwd:"17"},
            {name:"ì´ì€ìœ¨",pwd:"18"},{name:"ì´ì •ìš°",pwd:"19"},{name:"ì „ì€ì¬",pwd:"21"},{name:"ìµœì•„ë¯¼",pwd:"22"},
            {name:"ë°©ì¤€ì›",pwd:"23"},{name:"ì„±ìš°í˜‘",pwd:"24"}
        ],
        "2": [
            {name:"ê¹€ì‹œì•ˆ",pwd:"1"},{name:"ê¹€ì£¼ì•„",pwd:"2"},{name:"ê¹€ì£¼í™˜",pwd:"3"},{name:"ê¹€í•˜ë¯¼",pwd:"4"},
            {name:"ê¹€í•œê²°",pwd:"5"},{name:"ë…¸ìœ¤ì¬",pwd:"6"},{name:"ë¬¸ì‹œìš°",pwd:"7"},{name:"ë°•ì‹œì€",pwd:"8"},
            {name:"ë°©ìœ ë¯¼",pwd:"9"},{name:"ì•ˆì†Œë‘",pwd:"10"},{name:"ì˜¤ì„œìœ¨",pwd:"11"},{name:"ìœ¤ì§€í˜„",pwd:"12"},
            {name:"ì´ë„ìœ¤",pwd:"13"},{name:"ì´ì€ì„±",pwd:"14"},{name:"ì „ë¯¼í˜¸",pwd:"15"},{name:"ì°¨ì„œì•„",pwd:"16"},
            {name:"ìµœí•œì„¤",pwd:"17"},{name:"í•œì¬ì´",pwd:"18"},{name:"í—ˆì§€ì™„",pwd:"19"},{name:"í™ì±„í˜„",pwd:"20"},
            {name:"í™©ìœ ì†”",pwd:"21"},{name:"í™© í¬",pwd:"22"},{name:"ì´ë´„ì˜",pwd:"23"}
        ],
        "3": [
            {name:"ê³ ì°¬ë¹ˆ",pwd:"1"},{name:"êµ¬ì„œê·œ",pwd:"2"},{name:"ê¹€ë‹¨í•˜",pwd:"3"},{name:"ê¹€ë¯¼ì±„",pwd:"4"},
            {name:"ê¹€ì‹œí˜„",pwd:"5"},{name:"ê¹€ì£¼ì•„",pwd:"6"},{name:"ê¹€í•´ìœ¤",pwd:"7"},{name:"ë°•ë¯¼ìš°",pwd:"8"},
            {name:"ì†¡ì„œí˜„",pwd:"9"},{name:"ìœ ê¸°í˜„",pwd:"10"},{name:"ì´ë‹¨ë¹„",pwd:"11"},{name:"ì´ë£¨ì•„",pwd:"12"},
            {name:"ì´ìœ ë¹ˆ",pwd:"13"},{name:"ì´ì€",pwd:"14"},{name:"ì´í•´ë¦¬",pwd:"15"},{name:"ì¥í•˜ìœ¤",pwd:"16"},
            {name:"ì „ì†Œìœ¨",pwd:"17"},{name:"ì •ì•„ìœ¤",pwd:"18"},{name:"ì¡°ì´ë ˆ",pwd:"19"},{name:"í•œì§€ë¯¼",pwd:"21"},
            {name:"ì„œì—°í¬",pwd:"22"},{name:"ì˜¤íœ˜ë²”",pwd:"23"}
        ],
        "4": [
            {name:"ì‚¬ë¬´ì—˜",pwd:"1"},{name:"ê²½ë¼í˜„",pwd:"3"},{name:"ê²½ì´í•œ",pwd:"4"},{name:"ê¹€ê·œë¹ˆ",pwd:"5"},
            {name:"ê¹€ê¸°ì¨",pwd:"6"},{name:"ê¹€ì‚¬ë‘",pwd:"7"},{name:"ê¹€ìœ¤ì„œ",pwd:"8"},{name:"ê¹€ì¬í•˜",pwd:"9"},
            {name:"ë‚¨ì´ì†”",pwd:"10"},{name:"ë°•ë„ë‹´",pwd:"11"},{name:"ë°•ì˜ˆë¦°",pwd:"12"},{name:"ì‹ ë³´ë¯¼",pwd:"13"},
            {name:"ì‹ ìš°ì£¼",pwd:"14"},{name:"ì‹¬ë¡œì•„",pwd:"15"},{name:"ì´ê°•ì¤€",pwd:"16"},{name:"ì´ì˜ì„œ",pwd:"17"},
            {name:"ì„ì§€ìœ¨",pwd:"18"},{name:"ì •í•˜ì—°",pwd:"19"},{name:"ì¡°ì—°ì„œ",pwd:"20"},{name:"ì£¼ë‘ë¦¼",pwd:"21"},
            {name:"í™©ì±„ìœ¤",pwd:"22"},{name:"ë°°ì‹œí˜„",pwd:"23"}
        ]
    };

    // ìºë¦­í„° ë°ì´í„° ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì†ŒìŠ¤ ì ìš©)
    const CHARACTERS = [
        {
            id: 'basic', 
            name: 'ìƒˆë¡œìš´', 
            price: 0, 
            desc: 'í•­ìƒ ë°ê²Œ ì›ƒëŠ” ìƒˆë¡œìš´ ì¹œêµ¬!',
            imgNormal: 'https://i.imgur.com/ZzKwRQL.png',
            imgCorrect: 'https://i.imgur.com/Hu8cRBf.png',
            imgWrong: 'https://i.imgur.com/fxlkim6.png'
        },
        {
            id: 'cat', 
            name: 'ëƒì˜¹ì´', 
            price: 200, 
            desc: 'ë„ë„í•˜ì§€ë§Œ ì •ë‹µì„ ë§ì¶”ë©´ ì¢‹ì•„í•´ìš”.',
            imgNormal: 'https://i.imgur.com/B6qixEF.png',
            imgCorrect: 'https://i.imgur.com/qBZ8rrf.png',
            imgWrong: 'https://i.imgur.com/nsWFy5R.png'
        },
        {
            id: 'chori', 
            name: 'ìµ¸ë¦¬', 
            price: 200, 
            desc: 'ì¥ë‚œê¾¸ëŸ¬ê¸° ìµ¸ë¦¬!',
            imgNormal: 'https://i.imgur.com/G7r2vk7.png',
            imgCorrect: 'https://i.imgur.com/3Vzd2Ca.png',
            imgWrong: 'https://i.imgur.com/Xk2oruL.png'
        },
        {
            id: 'mango', 
            name: 'ë§ê³ ', 
            price: 200, 
            desc: 'ë‹¬ì½¤í•œ ë§ê³ ì²˜ëŸ¼ ìƒí¼í•´ìš”.',
            imgNormal: 'https://i.imgur.com/qw7wlKB.png',
            imgCorrect: 'https://i.imgur.com/wLPLFzh.png',
            imgWrong: 'https://i.imgur.com/goA0Zya.png'
        },
        {
            id: 'tuitui', 
            name: 'íˆ¬ì´íˆ¬ì´', 
            price: 200, 
            desc: 'ëˆˆì´ ì´ˆë¡±ì´ˆë¡±í•œ íˆ¬ì´íˆ¬ì´.',
            imgNormal: 'https://i.imgur.com/DHzyly7.png',
            imgCorrect: 'https://i.imgur.com/wx1fm0C.png',
            imgWrong: 'https://i.imgur.com/UOI5GbQ.png'
        },
        {
            id: 'honey', 
            name: 'ê¿€ì¸', 
            price: 200, 
            desc: 'ê¿€ì„ ì¢‹ì•„í•˜ëŠ” ê·€ì—¬ìš´ ê³°.',
            imgNormal: 'https://i.imgur.com/0GQxnXh.png',
            imgCorrect: 'https://i.imgur.com/AzEMVCL.png',
            imgWrong: 'https://i.imgur.com/hyfnGFx.png'
        },
        {
            id: 'time', 
            name: 'ì‹œê°ì´', 
            price: 200, 
            desc: 'ì‹œê°„ì˜ ìˆ²ì˜ ê°€ì´ë“œ ì‹œê°ì´!',
            imgNormal: 'https://i.imgur.com/vmqQ5kG.png',
            imgCorrect: 'https://i.imgur.com/hfUwBOu.png',
            imgWrong: 'https://i.imgur.com/CUmcDwW.png'
        },
        {
            id: 'redcat', 
            name: 'ë¹¨ëƒ¥', 
            price: 200, 
            desc: 'ì—´ì •ì ì¸ ë¹¨ê°„ ê³ ì–‘ì´.',
            imgNormal: 'https://i.imgur.com/ccxG70t.png',
            imgCorrect: 'https://i.imgur.com/DIdFXRk.png',
            imgWrong: 'https://i.imgur.com/nWR1xYj.png'
        },
        {
            id: 'iruri', 
            name: 'ì´ë£¨ë¦¬', 
            price: 200, 
            desc: 'ê¿ˆì„ ì´ë£¨ì–´ì£¼ëŠ” ìš”ì •.',
            imgNormal: 'https://i.imgur.com/3ossOM4.png',
            imgCorrect: 'https://i.imgur.com/uKtS40n.png',
            imgWrong: 'https://i.imgur.com/nxJBK4n.png'
        }
    ];

    let activePlayers = []; 
    let currentPlayerIdx = 0;
    let timerInterval = null;
    let currentProblem = null;
    let currentClockMinutes = 0; 
    let currentAttempt = 0;
    let gameConfig = { useBefore: false, useHard: false };
    
    // ì„ íƒëœ ìƒì  ì•„ì´í…œ ì„ì‹œ ì €ì¥ìš©
    let selectedShopItem = null;

    function loadStudentNames() {
        const cls = document.getElementById('login-class').value;
        const nameSelect = document.getElementById('login-name');
        nameSelect.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>';
        if (DB_STUDENTS[cls]) {
            DB_STUDENTS[cls].forEach(st => {
                const opt = document.createElement('option');
                opt.value = st.name; opt.textContent = st.name;
                nameSelect.appendChild(opt);
            });
        }
    }

    // --- ì„œë²„ í†µì‹  ë¡œê·¸ì¸ ---
    async function addPlayer() {
        if(!SCRIPT_URL) { alert("ìŠ¤í¬ë¦½íŠ¸ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }
        if (activePlayers.length >= 4) { showToast("ìµœëŒ€ 4ëª…ê¹Œì§€ë§Œ í•  ìˆ˜ ìˆì–´ìš”!"); return; }
        
        const cls = document.getElementById('login-class').value;
        const name = document.getElementById('login-name').value;
        const pwd = document.getElementById('login-pwd').value.trim();

        if (!cls || !name || !pwd) { showToast("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if (activePlayers.find(p => p.name === name)) { showToast("ì´ë¯¸ ì¶”ê°€ëœ ì¹œêµ¬ì˜ˆìš”."); return; }

        setLoading(true);
        try {
            const response = await fetch(`${SCRIPT_URL}?action=login&class=${cls}&name=${name}&pwd=${pwd}`);
            const json = await response.json();

            if (json.result === "success") {
                const userData = json.data;
                let safeChars = ['basic'];
                if (Array.isArray(userData.chars)) {
                    safeChars = userData.chars;
                } else if (typeof userData.chars === 'string') {
                    safeChars = userData.chars.split(',').map(s => s.trim());
                }

                activePlayers.push({
                    class: cls, name: name, score: 0, 
                    timeLeft: 180, consecutiveCorrect: 0, consecutiveWrong: 0,
                    charId: 'basic', 
                    points: parseInt(userData.points) || 0,
                    unlockedChars: safeChars,
                    highScore: parseInt(userData.score) || 0
                });
                renderPlayerList();
                document.getElementById('login-pwd').value = '';
                showToast(`í™˜ì˜í•´, ${name}!`);
            } else {
                showToast(json.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨!");
            }
        } catch (e) {
            console.error(e);
            showToast("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆì–´ìš”. (í…ŒìŠ¤íŠ¸ ëª¨ë“œë¼ë©´ ì½”ë“œ ìƒë‹¨ì˜ URLì„ í™•ì¸í•˜ì„¸ìš”)");
            // --- ì˜¤í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ìš© (ì„œë²„ ì‹¤íŒ¨ì‹œ ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬) ---
            // ì‹¤ì œ ë°°í¬ì‹œì—ëŠ” ì•„ë˜ ë¸”ë¡ì„ ì£¼ì„ ì²˜ë¦¬ í•˜ì„¸ìš”.
            /*
            activePlayers.push({
                class: cls, name: name, score: 0, 
                timeLeft: 180, consecutiveCorrect: 0, consecutiveWrong: 0,
                charId: 'basic', 
                points: 500, // í…ŒìŠ¤íŠ¸ìš© 500í¬ì¸íŠ¸
                unlockedChars: ['basic'],
                highScore: 0
            });
            renderPlayerList();
            document.getElementById('login-pwd').value = '';
            showToast(`[í…ŒìŠ¤íŠ¸ ëª¨ë“œ] í™˜ì˜í•´, ${name}!`);
            */
            // ----------------------------------------------------
        } finally {
            setLoading(false);
        }
    }

    function renderPlayerList() {
        const list = document.getElementById('intro-player-list');
        list.innerHTML = '';
        activePlayers.forEach((p, idx) => {
            const badge = document.createElement('div');
            badge.className = 'player-badge';
            badge.innerHTML = `<span>${idx+1}P ${p.name}</span> <span style="cursor:pointer; margin-left:5px; color:#c62828;" onclick="removePlayer(${idx})">âœ–</span>`;
            list.appendChild(badge);
        });
        document.getElementById('btn-goto-lobby').disabled = activePlayers.length === 0;
    }

    function removePlayer(idx) { activePlayers.splice(idx, 1); renderPlayerList(); }

    function goToLobby() {
        if(activePlayers.length === 0) return;
        showScreen('screen-lobby');
        fetchRank();
        updateLobbyUI();
    }

    // --- ì„œë²„ í†µì‹  ë­í‚¹ ---
    async function fetchRank() {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=rank`);
            const json = await response.json();
            if (json.result === "success") {
                const list = document.getElementById('rank-list');
                list.innerHTML = '';
                json.data.forEach((r, i) => {
                    list.innerHTML += `<li>${i+1}ìœ„: ${r.name} (${r.score}ì )</li>`;
                });
            }
        } catch(e) { console.error(e); }
    }

    function updateLobbyUI() {
        let container = document.querySelector('.char-select-area h3');
        if(!document.getElementById('lobby-player-select')) {
            const select = document.createElement('select');
            select.id = 'lobby-player-select';
            select.style.marginLeft = '10px'; select.style.padding = '5px';
            select.style.fontSize = '1.2rem'; select.style.fontFamily = 'Jua';
            select.onchange = renderShop;
            container.appendChild(select);
        }
        const select = document.getElementById('lobby-player-select');
        select.innerHTML = '';
        activePlayers.forEach((p, idx) => {
            const opt = document.createElement('option');
            opt.value = idx; opt.textContent = `${idx+1}P ${p.name}`;
            select.appendChild(opt);
        });
        renderShop();
        
        const pIdx = select.value || 0;
        document.getElementById('my-best-score').textContent = activePlayers[pIdx].highScore + 'ì ';
    }

    function renderShop() {
        const pIdx = document.getElementById('lobby-player-select').value || 0;
        const player = activePlayers[pIdx];
        document.getElementById('lobby-points').textContent = player.points;
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        
        document.getElementById('my-best-score').textContent = player.highScore + 'ì ';
        
        CHARACTERS.forEach(char => {
            const item = document.createElement('div');
            item.className = 'shop-item';
            const isUnlocked = player.unlockedChars.includes(char.id);
            const isSelected = player.charId === char.id;
            if (!isUnlocked) item.classList.add('locked');
            if (isSelected) item.classList.add('selected');
            
            // ì´ë¯¸ì§€ í‘œì‹œ (ê¸°ë³¸ ì´ë¯¸ì§€)
            item.innerHTML = `<img src="${char.imgNormal}"><div style="font-weight:bold; font-size:1.1rem;">${char.name}</div>
                ${!isUnlocked ? `<div class="shop-price">${char.price}P</div><div class="lock-icon">ğŸ”’</div>` : ''}
                ${isSelected ? '<div style="color:#c62828; font-size:0.9rem; font-weight:bold;">ì„ íƒë¨</div>' : ''}`;
            
            // í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
            item.onclick = () => {
                openCharDetail(char.id);
            };
            grid.appendChild(item);
        });
    }

    // --- ìºë¦­í„° ìƒì„¸ ëª¨ë‹¬ ë¡œì§ ---
    function openCharDetail(charId) {
        const pIdx = document.getElementById('lobby-player-select').value || 0;
        const player = activePlayers[pIdx];
        const charInfo = CHARACTERS.find(c => c.id === charId);
        
        if (!charInfo) return;

        selectedShopItem = charInfo; // í˜„ì¬ ë³´ê³  ìˆëŠ” ì•„ì´í…œ ì €ì¥

        // ëª¨ë‹¬ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('detail-char-img').src = charInfo.imgNormal;
        document.getElementById('detail-char-name').textContent = charInfo.name;
        document.getElementById('detail-char-desc').textContent = charInfo.desc || "íŠ¹ë³„í•œ ëŠ¥ë ¥ì„ ê°€ì§„ ì¹œêµ¬ì…ë‹ˆë‹¤.";
        document.getElementById('detail-char-price').textContent = `ê°€ê²©: ${charInfo.price}P`;

        const btnGroup = document.getElementById('detail-btn-group');
        btnGroup.innerHTML = '';

        const isUnlocked = player.unlockedChars.includes(charId);
        const isEquipped = player.charId === charId;

        if (isUnlocked) {
            // ì´ë¯¸ ë³´ìœ  ì¤‘ì¸ ê²½ìš°
            document.getElementById('detail-question').textContent = "ì´ë¯¸ ë³´ìœ ì¤‘ì¸ ìºë¦­í„°ì…ë‹ˆë‹¤.";
            
            // [ë„¤ (ë¹„í™œì„±í™”)] ë²„íŠ¼
            const btnYes = document.createElement('button');
            btnYes.className = 'btn btn-neutral';
            btnYes.textContent = 'ë„¤ (êµ¬ë§¤ë¨)';
            btnYes.disabled = true; // ìš”ì²­: êµ¬ë§¤í–ˆë‹¤ë©´ ë„¤ ë²„íŠ¼ ë¹„í™œì„±í™”
            btnGroup.appendChild(btnYes);

            // [ì•„ë‹ˆì˜¤ (ë‹«ê¸°)] ë²„íŠ¼
            const btnNo = document.createElement('button');
            btnNo.className = 'btn btn-secondary';
            btnNo.textContent = 'ì•„ë‹ˆì˜¤ (ë‹«ê¸°)';
            btnNo.onclick = closeCharModal;
            btnGroup.appendChild(btnNo);
            
            // [ì¥ì°©í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€ (í¸ì˜ì„±)
            if (!isEquipped) {
                const btnEquip = document.createElement('button');
                btnEquip.className = 'btn btn-primary';
                btnEquip.textContent = 'ì¥ì°©í•˜ê¸°';
                btnEquip.style.marginLeft = '10px';
                btnEquip.onclick = () => {
                    player.charId = charId;
                    renderShop();
                    closeCharModal();
                    showToast(`${charInfo.name} ì¥ì°© ì™„ë£Œ!`);
                    savePlayerData(player);
                };
                btnGroup.appendChild(btnEquip);
            } else {
                 const label = document.createElement('span');
                 label.style.alignSelf = 'center';
                 label.style.marginLeft = '10px';
                 label.style.fontWeight = 'bold';
                 label.style.color = '#c62828';
                 label.textContent = "(í˜„ì¬ ì¥ì°©ì¤‘)";
                 btnGroup.appendChild(label);
            }

        } else {
            // ë¯¸ë³´ìœ  ì‹œ êµ¬ë§¤ ë¡œì§
            document.getElementById('detail-question').textContent = "ìºë¦­í„°ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            
            // [ë„¤ (êµ¬ë§¤)]
            const btnBuy = document.createElement('button');
            btnBuy.className = 'btn btn-primary';
            btnBuy.textContent = 'ë„¤ (êµ¬ë§¤)';
            btnBuy.onclick = () => {
                if (player.points >= charInfo.price) {
                    player.points -= charInfo.price;
                    player.unlockedChars.push(charId);
                    
                    // êµ¬ë§¤ ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸ (ì¬ê·€ í˜¸ì¶œë¡œ ë²„íŠ¼ ìƒíƒœ ê°±ì‹ )
                    showToast(`ğŸ‰ ${charInfo.name} íšë“!`);
                    savePlayerData(player);
                    renderShop(); // ë’¤ìª½ ìƒì  ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                    openCharDetail(charId); // ëª¨ë‹¬ ë‚´ìš© ê°±ì‹  (êµ¬ë§¤ë¨ ìƒíƒœë¡œ)
                } else {
                    showToast("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”! ğŸ˜­");
                }
            };
            btnGroup.appendChild(btnBuy);

            // [ì•„ë‹ˆì˜¤ (ì·¨ì†Œ)]
            const btnCancel = document.createElement('button');
            btnCancel.className = 'btn btn-secondary';
            btnCancel.textContent = 'ì•„ë‹ˆì˜¤';
            btnCancel.onclick = closeCharModal;
            btnGroup.appendChild(btnCancel);
        }

        document.getElementById('modal-char-detail').style.display = 'flex';
    }

    function closeCharModal() {
        document.getElementById('modal-char-detail').style.display = 'none';
        selectedShopItem = null;
    }

    // --- ì„œë²„ í†µì‹  ì €ì¥ ---
    function savePlayerData(player) {
        const payload = {
            class: player.class,
            name: player.name,
            score: player.score > player.highScore ? player.score : player.highScore,
            points: player.points,
            chars: player.unlockedChars
        };
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(json => {
            console.log("Saved:", json);
        }).catch(err => console.error(err));
    }

    // --- ê²Œì„ ë¡œì§ ---
    function startGame() {
        showScreen('screen-game');
        gameConfig.useBefore = document.getElementById('opt-before').checked;
        gameConfig.useHard = document.getElementById('opt-hard').checked;
        currentPlayerIdx = 0;
        activePlayers.forEach(p => { 
            p.score = 0; p.consecutiveCorrect = 0; p.consecutiveWrong = 0; p.timeLeft = 180; 
        });
        clearInterval(timerInterval);
        timerInterval = setInterval(gameLoop, 1000);
        nextTurn();
    }

    function gameLoop() {
        const currentPlayer = activePlayers[currentPlayerIdx];
        if (currentPlayer && currentPlayer.timeLeft > 0) {
            currentPlayer.timeLeft--;
            updateGameUI();
            if (currentPlayer.timeLeft <= 0) {
                showToast(`â° ${currentPlayer.name} ì‹œê°„ ì¢…ë£Œ!`);
                let nextIdx = (currentPlayerIdx + 1) % activePlayers.length;
                let loopCount = 0;
                while (activePlayers[nextIdx].timeLeft <= 0) {
                    nextIdx = (nextIdx + 1) % activePlayers.length;
                    loopCount++;
                    if (loopCount >= activePlayers.length) { endGame(); return; }
                }
                currentPlayerIdx = nextIdx;
                nextTurn();
            }
        }
    }

    function updateGameUI() {
        const player = activePlayers[currentPlayerIdx];
        const charInfo = CHARACTERS.find(c => c.id === player.charId);
        
        // í˜„ì¬ ë¦¬ì•¡ì…˜ ìƒíƒœ í™•ì¸ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
        if (!player.reactionState) player.reactionState = 'normal';
        
        const imgEl = document.getElementById('game-char-img');
        
        // ìƒíƒœì— ë”°ë¥¸ ì´ë¯¸ì§€ ì†ŒìŠ¤ ê²°ì •
        let targetSrc = charInfo.imgNormal;
        if (player.reactionState === 'correct') targetSrc = charInfo.imgCorrect;
        else if (player.reactionState === 'wrong') targetSrc = charInfo.imgWrong;
        
        // ì´ë¯¸ì§€ ì†ŒìŠ¤ê°€ ë‹¤ë¥¼ ë•Œë§Œ ë³€ê²½ (ê¹œë¹¡ì„ ë°©ì§€)
        if (imgEl.src !== targetSrc) {
            imgEl.src = targetSrc;
        }

        document.getElementById('game-player-name').textContent = player.name;
        document.getElementById('game-score-info').textContent = `${player.score}ì `;
        const pct = (player.timeLeft / 180) * 100;
        document.getElementById('timer-bar').style.width = pct + '%';
        if(pct < 20) document.getElementById('timer-bar').style.background = '#e91e63';
        else if(pct < 50) document.getElementById('timer-bar').style.background = '#ff9800';
        else document.getElementById('timer-bar').style.background = '#4caf50';
        const m = Math.floor(player.timeLeft / 60);
        const s = player.timeLeft % 60;
        document.getElementById('timer-text').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    // ìºë¦­í„° ë¦¬ì•¡ì…˜ ì„¤ì • í•¨ìˆ˜
    function setCharacterReaction(state) {
        const player = activePlayers[currentPlayerIdx];
        player.reactionState = state;
        updateGameUI();
        
        // 2ì´ˆ í›„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µê·€
        if (state !== 'normal') {
            setTimeout(() => {
                if (activePlayers[currentPlayerIdx] === player) { // í”Œë ˆì´ì–´ê°€ ë°”ë€Œì§€ ì•Šì•˜ë‹¤ë©´
                    player.reactionState = 'normal';
                    updateGameUI();
                }
            }, 2000);
        }
    }

    function nextTurn() {
        let loop = 0;
        while(activePlayers[currentPlayerIdx].timeLeft <= 0) {
            currentPlayerIdx = (currentPlayerIdx + 1) % activePlayers.length;
            loop++;
            if(loop > activePlayers.length) { endGame(); return; }
        }
        const player = activePlayers[currentPlayerIdx];
        player.reactionState = 'normal'; // í„´ ì‹œì‘ì‹œ í‰ì˜¨í•œ í‘œì •
        updateGameUI();
        document.getElementById('hint-bubble').style.display = 'none'; 
        generateProblem(player);
    }

    function generateProblem(player) {
        currentAttempt = 0;
        player.problemStartTime = player.timeLeft;

        let types = [1, 2];
        if (gameConfig.useBefore) types.push(3, 4);
        let r = Math.random();
        let selectedType = 1;
        if (gameConfig.useBefore) {
            let hardProb = 0.5; 
            if (player.consecutiveCorrect > 1) hardProb = 0.8; 
            if (player.consecutiveWrong > 1) hardProb = 0.2; 
            if (r < hardProb) selectedType = Math.random() < 0.5 ? 3 : 4;
            else selectedType = Math.random() < 0.5 ? 1 : 2;
        } else { selectedType = Math.random() < 0.5 ? 1 : 2; }

        let h, m;
        h = Math.floor(Math.random() * 12) + 1;
        if (gameConfig.useHard) {
            if (selectedType >= 3) m = Math.floor(Math.random() * 20) + 40; 
            else m = Math.floor(Math.random() * 60);
        } else {
            if (selectedType >= 3) { const opts = [40, 45, 50, 55]; m = opts[Math.floor(Math.random() * opts.length)]; }
            else { m = Math.floor(Math.random() * 12) * 5; }
        }
        let totalM = (h === 12 ? 12 : h) * 60 + m; 
        if (h===12 && m===0) totalM = 12 * 60; 
        currentProblem = { type: selectedType, h: h, m: m, totalM: totalM };
        
        const pText = document.getElementById('problem-text');
        const inpWrap = document.getElementById('input-wrapper');
        const suffix = document.getElementById('text-suffix');
        inpWrap.style.display = 'none';
        document.getElementById('inp-hour').value = '';
        document.getElementById('inp-min').value = '';
        isClockInteractive = false;

        if (selectedType === 1) { 
            pText.innerHTML = `<span style="color:var(--accent-color)">${h}ì‹œ ${String(m).padStart(2,'0')}ë¶„</span>ì„ ë§Œë“œì„¸ìš”.`;
            isClockInteractive = true; currentClockMinutes = Math.floor(Math.random() * 720); 
        } else if (selectedType === 2) { 
            pText.textContent = "ì‹œê³„ë¥¼ ë³´ê³  ì‹œê°ì„ ì“°ì„¸ìš”.";
            inpWrap.style.display = 'flex'; suffix.style.display = 'none'; currentClockMinutes = totalM;
        } else if (selectedType === 3) { 
            let nextH = (h % 12) + 1; let beforeM = 60 - m;
            pText.innerHTML = `<span style="color:var(--accent-color)">${nextH}ì‹œ ${beforeM}ë¶„ ì „</span>ì„ ë§Œë“œì„¸ìš”.`;
            isClockInteractive = true; currentClockMinutes = Math.floor(Math.random() * 720);
        } else if (selectedType === 4) { 
            pText.textContent = "ëª‡ ì‹œ ëª‡ ë¶„ ì „ì¼ê¹Œìš”?";
            inpWrap.style.display = 'flex'; suffix.style.display = 'inline'; currentClockMinutes = totalM;
        }
        drawClock();
    }

    function showFeedbackAnim(isCorrect) {
        const el = document.getElementById('feedback-anim');
        el.textContent = isCorrect ? 'â­•' : 'âŒ';
        el.className = 'feedback-overlay ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');
        el.style.animation = 'none'; el.offsetHeight; 
        el.style.animation = 'feedbackPop 0.8s ease-out forwards';
    }

    function submitAnswer() {
        if (!currentProblem) return;
        let isCorrect = false;
        const player = activePlayers[currentPlayerIdx];
        
        if (currentProblem.type === 1 || currentProblem.type === 3) {
            let userM = Math.round(currentClockMinutes);
            let diff = Math.abs(userM - currentProblem.totalM);
            while(diff >= 720) diff -= 720;
            if (diff === 0 || diff === 720) isCorrect = true;
        } else if (currentProblem.type === 2) {
            const uH = parseInt(document.getElementById('inp-hour').value);
            const uM = parseInt(document.getElementById('inp-min').value);
            let ansH = currentProblem.h; let ansM = currentProblem.m;
            if (uH === ansH && uM === ansM) isCorrect = true;
        } else if (currentProblem.type === 4) {
            const uH = parseInt(document.getElementById('inp-hour').value);
            const uM = parseInt(document.getElementById('inp-min').value);
            let ansH = (currentProblem.h % 12) + 1; let ansM = 60 - currentProblem.m;
            if (uH === ansH && uM === ansM) isCorrect = true;
        }

        if (isCorrect) {
            showFeedbackAnim(true);
            setCharacterReaction('correct'); // ì •ë‹µ ë¦¬ì•¡ì…˜

            let gainedScore = 10;
            let bonuses = [];

            if (gameConfig.useHard || currentProblem.type >= 3) {
                gainedScore += 10;
                bonuses.push("âœ¨ì‹¬í™”");
            }
            const timeTaken = player.problemStartTime - player.timeLeft; 
            if (timeTaken <= 10) {
                gainedScore += 5;
                bonuses.push("âš¡ìŠ¤í”¼ë“œ");
            }
            player.consecutiveCorrect++;
            if (player.consecutiveCorrect >= 3) {
                gainedScore += 5;
                bonuses.push(`ğŸ”¥${player.consecutiveCorrect}ì—°ìŠ¹`);
            }
            
            player.score += gainedScore;
            player.consecutiveWrong = 0;

            let msg = `ì •ë‹µ! +${gainedScore}ì `;
            if (bonuses.length > 0) {
                msg += `\n(${bonuses.join(', ')})`;
            }
            showToast(msg);

            setTimeout(() => {
                let nextIdx = (currentPlayerIdx + 1) % activePlayers.length;
                let loopCount = 0;
                while (activePlayers[nextIdx].timeLeft <= 0) {
                    nextIdx = (nextIdx + 1) % activePlayers.length;
                    loopCount++;
                    if (loopCount >= activePlayers.length) { endGame(); return; }
                }
                currentPlayerIdx = nextIdx;
                nextTurn();
            }, 1000);
        } else {
            currentAttempt++;
            showFeedbackAnim(false);
            setCharacterReaction('wrong'); // ì˜¤ë‹µ ë¦¬ì•¡ì…˜

            if (currentAttempt < 2) {
                showToast(`í‹€ë ¸ì–´ìš”! íŒíŠ¸ë¥¼ ì¤„ê²Œìš”. (ê¸°íšŒ 1ë²ˆ ë‚¨ìŒ)`);
                player.consecutiveCorrect = 0;
                showHint();
            } else {
                showToast("ì•„ì‰½ë„¤ìš”! ë‹¤ìŒ ì¹œêµ¬ì—ê²Œ ë„˜ì–´ê°‘ë‹ˆë‹¤!");
                player.consecutiveCorrect = 0;
                player.consecutiveWrong++;
                setTimeout(() => {
                    let nextIdx = (currentPlayerIdx + 1) % activePlayers.length;
                    let loopCount = 0;
                    while (activePlayers[nextIdx].timeLeft <= 0) {
                        nextIdx = (nextIdx + 1) % activePlayers.length;
                        loopCount++;
                        if (loopCount >= activePlayers.length) { endGame(); return; }
                    }
                    currentPlayerIdx = nextIdx;
                    nextTurn();
                }, 2000);
            }
        }
    }
    
    function showHint() {
        const bubble = document.getElementById('hint-bubble');
        bubble.style.display = 'block';
        const type = currentProblem.type;
        if (type === 1) bubble.textContent = `ğŸ’¡ íŒíŠ¸: ì§§ì€ ë°”ëŠ˜ì„ ${currentProblem.h} ê·¼ì²˜ë¡œ ê°€ì ¸ê°€ë³´ì„¸ìš”.`;
        else if (type === 2) bubble.textContent = "ğŸ’¡ íŒíŠ¸: ê¸´ ë°”ëŠ˜ì´ ê°€ë¦¬í‚¤ëŠ” ìˆ«ìì— 5ë¥¼ ê³±í•´ë³´ì„¸ìš”.";
        else if (type === 3) {
            const nextH = (currentProblem.h % 12) + 1;
            bubble.textContent = `ğŸ’¡ íŒíŠ¸: ${nextH}ì‹œê°€ ë˜ê¸°ê¹Œì§€ ì–¼ë§ˆë‚˜ ë‚¨ì•˜ë‚˜ìš”?`;
        } else if (type === 4) bubble.textContent = "ğŸ’¡ íŒíŠ¸: ê³§ ëª‡ ì‹œê°€ ë˜ë‚˜ìš”? 12ê¹Œì§€ ëª‡ ì¹¸ ë‚¨ì•˜ë‚˜ìš”?";
    }

    function endGame() {
        clearInterval(timerInterval);
        showScreen('screen-result');
        const tbody = document.getElementById('result-list');
        tbody.innerHTML = '';
        
        let sorted = [...activePlayers].sort((a,b) => b.score - a.score);
        sorted.forEach((p, idx) => {
            const earnedPoints = Math.floor(p.score * 0.2); 
            p.points += earnedPoints;
            
            savePlayerData(p);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}ìœ„</td><td style="font-weight:bold;">${p.name}</td>
                <td style="color:var(--accent-color); font-weight:bold;">${p.score}ì </td>
                <td style="color:#f57f17;">+${earnedPoints}P</td>`;
            tbody.appendChild(tr);
        });
    }

    // --- ìº”ë²„ìŠ¤ ì‹œê³„ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const size = 300; const center = size / 2; const radius = size / 2 - 15;
    let isDragging = false; let isClockInteractive = false;

    function drawClock() {
        // ë°˜ì‘í˜•ìœ¼ë¡œ ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ë³€ê²½ë˜ë©´ ìŠ¤ì¼€ì¼ ì¡°ì • í•„ìš”í•  ìˆ˜ ìˆìŒ
        // í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” CSS í¬ê¸°ë§Œ ë³€í•˜ê³  ìº”ë²„ìŠ¤ ë‚´ë¶€ í•´ìƒë„(width/height ì†ì„±)ëŠ” 300 ê³ ì •ì´ë¼ ìŠ¤ì¼€ì¼ë§ì€ ë¸Œë¼ìš°ì €ê°€ ì²˜ë¦¬í•¨
        ctx.clearRect(0, 0, size, size);
        ctx.fillStyle = isClockInteractive ? "#fff" : "#f5f5f5";
        ctx.beginPath(); ctx.arc(center, center, radius, 0, 2*Math.PI); ctx.fill();
        ctx.lineWidth = 8; ctx.strokeStyle = "#8d6e63"; ctx.stroke();
        
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#333';
        for(let i=1; i<=12; i++) {
            const angle = (i * 30) * Math.PI / 180;
            const x = center + (radius - 35) * Math.sin(angle);
            const y = center - (radius - 35) * Math.cos(angle);
            ctx.font = 'bold 24px Jua'; ctx.fillText(i, x, y);
            const tx = center + (radius - 12) * Math.sin(angle);
            const ty = center - (radius - 12) * Math.cos(angle);
            ctx.beginPath(); ctx.arc(tx, ty, 4, 0, 2*Math.PI); ctx.fillStyle='#555'; ctx.fill();
        }
        for(let i=0; i<60; i++) {
            if(i%5!==0) {
                const a = (i*6)*Math.PI/180;
                const tx = center + (radius - 12) * Math.sin(a);
                const ty = center - (radius - 12) * Math.cos(a);
                ctx.beginPath(); ctx.arc(tx, ty, 2, 0, 2*Math.PI); ctx.fillStyle='#ccc'; ctx.fill();
            }
        }
        const normM = currentClockMinutes % 720;
        const mA = (normM % 60) * 6 * Math.PI / 180;
        const hA = (normM * 0.5) * Math.PI / 180;
        drawHand(hA, radius*0.55, 10, '#3e2723');
        drawHand(mA, radius*0.8, 6, '#c62828');
        ctx.beginPath(); ctx.arc(center, center, 8, 0, 2*Math.PI); ctx.fillStyle='#3e2723'; ctx.fill();
    }
    function drawHand(angle, length, width, color) {
        ctx.beginPath(); ctx.lineWidth = width; ctx.lineCap = "round"; ctx.strokeStyle = color;
        ctx.moveTo(center, center);
        ctx.lineTo(center + length * Math.sin(angle), center - length * Math.cos(angle));
        ctx.stroke();
    }
    function getAngle(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const x = cx - rect.left - rect.width/2; // ì¤‘ì‹¬ì  ê³„ì‚° ìˆ˜ì •
        const y = cy - rect.top - rect.height/2; // ì¤‘ì‹¬ì  ê³„ì‚° ìˆ˜ì •
        let a = Math.atan2(y, x) + Math.PI/2;
        if (a < 0) a += Math.PI * 2;
        return a;
    }
    let lastA = 0;
    function startDrag(e) { if(!isClockInteractive) return; isDragging = true; lastA = getAngle(e); e.preventDefault(); }
    function onDrag(e) {
        if(!isDragging || !isClockInteractive) return; e.preventDefault();
        const curA = getAngle(e); let delta = curA - lastA;
        if(delta > Math.PI) delta -= 2*Math.PI; if(delta < -Math.PI) delta += 2*Math.PI;
        currentClockMinutes += (delta / (2*Math.PI)) * 60;
        if(currentClockMinutes < 0) currentClockMinutes += 720;
        lastA = curA; drawClock();
    }
    function endDrag() { if(!isDragging) return; isDragging = false; currentClockMinutes = Math.round(currentClockMinutes); drawClock(); }
    
    canvas.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('mouseup', endDrag);
    canvas.addEventListener('touchstart', startDrag, {passive:false});
    window.addEventListener('touchmove', onDrag, {passive:false});
    window.addEventListener('touchend', endDrag);

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function openHelp() { document.getElementById('modal-help').style.display = 'flex'; }
    function closeHelp() { document.getElementById('modal-help').style.display = 'none'; }
    
    drawClock();
</script>
</body>
</html>

